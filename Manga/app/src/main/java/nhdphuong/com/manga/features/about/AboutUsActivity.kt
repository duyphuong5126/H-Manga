package nhdphuong.com.manga.features.about

import android.content.Context
import android.content.Intent
import androidx.appcompat.app.AppCompatActivity
import android.os.Bundle
import android.view.View
import android.widget.ImageButton
import kotlinx.android.synthetic.main.activity_about_us.tvTwitterInfo
import kotlinx.android.synthetic.main.activity_about_us.tvEmailInfo
import kotlinx.android.synthetic.main.activity_about_us.tvRepositoryInfo
import kotlinx.android.synthetic.main.activity_about_us.tvVersionLabel
import kotlinx.android.synthetic.main.activity_about_us.tvTagVersionLabel
import kotlinx.android.synthetic.main.activity_about_us.ibBack
import kotlinx.android.synthetic.main.activity_about_us.mbUpgradeButton
import kotlinx.android.synthetic.main.activity_about_us.scNotificationAcceptor
import nhdphuong.com.manga.BuildConfig
import nhdphuong.com.manga.NHentaiApp
import nhdphuong.com.manga.R
import nhdphuong.com.manga.supports.addClickAbleText
import nhdphuong.com.manga.supports.openEmailApp
import nhdphuong.com.manga.supports.openUrl
import nhdphuong.com.manga.views.becomeVisible
import nhdphuong.com.manga.views.customs.MyTextView
import javax.inject.Inject

class AboutUsActivity : AppCompatActivity(), AboutUsContract.View, View.OnClickListener {
    @Inject
    lateinit var presenter: AboutUsContract.Presenter

    private lateinit var twitterInfo: MyTextView
    private lateinit var emailInfo: MyTextView
    private lateinit var repositoryInfo: MyTextView
    private lateinit var versionLabel: MyTextView
    private lateinit var tagVersionLabel: MyTextView
    private lateinit var backButton: ImageButton

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_about_us)
        NHentaiApp.instance.applicationComponent.plus(AboutUsModule(this)).inject(this)

        setUpView()
        twitterInfo.addClickAbleText(TWITTER_URL, TWITTER_LABEL, this::openUrl)
        emailInfo.addClickAbleText(EMAIL, EMAIL) { emailAddress ->
            this.openEmailApp(emailAddress, BuildConfig.VERSION_NAME)
        }
        repositoryInfo.addClickAbleText(REPOSITORY_URL, REPOSITORY_LABEL, this::openUrl)
        versionLabel.text = getString(R.string.app_version_template, BuildConfig.VERSION_NAME)
        backButton.setOnClickListener(this)
        scNotificationAcceptor.setOnCheckedChangeListener { _, isChecked ->
            presenter.changeAppUpgradeNotificationAcceptance(isChecked)
        }
        mbUpgradeButton.setOnClickListener(this)
    }

    override fun onStart() {
        super.onStart()
        presenter.setUp()
    }

    override fun finish() {
        super.finish()
        overridePendingTransition(R.anim.fade_in, R.anim.fade_out)
    }

    override fun onDestroy() {
        presenter.clear()
        super.onDestroy()
    }

    override fun onClick(v: View?) {
        when (v?.id) {
            R.id.ibBack -> {
                onBackPressed()
            }

            R.id.mbUpgradeButton -> {
                openUrl(REPOSITORY_URL)
            }
        }
    }

    override fun showAppUpgradeNotificationAcceptance(notificationAllowed: Boolean) {
        scNotificationAcceptor.isChecked = notificationAllowed
    }

    override fun showAppUpgradeNotification(latestVersionCode: String) {
        mbUpgradeButton.text = getString(R.string.app_upgrade_button, latestVersionCode)
        mbUpgradeButton.becomeVisible()
    }

    override fun hideAppUpgradeNotification() {
        mbUpgradeButton.becomeVisible()
    }

    override fun showTagDataVersion(versionCode: String) {
        tagVersionLabel.text = getString(R.string.tag_data_version_template, versionCode)
    }

    private fun setUpView() {
        twitterInfo = tvTwitterInfo
        emailInfo = tvEmailInfo
        repositoryInfo = tvRepositoryInfo
        versionLabel = tvVersionLabel
        tagVersionLabel = tvTagVersionLabel
        backButton = ibBack
    }

    companion object {
        private const val TWITTER_LABEL = "Nonoka (@Nonoka5126)"
        private const val TWITTER_URL = "https://twitter.com/Nonoka5126"
        private const val REPOSITORY_LABEL = "My Github"
        private const val REPOSITORY_URL = "https://github.com/duyphuong5126/H-Manga/releases"
        private const val EMAIL = "kanade5126@gmail.com"

        @JvmStatic
        fun start(fromContext: Context) {
            val intent = Intent(fromContext, AboutUsActivity::class.java)
            fromContext.startActivity(intent)
        }
    }
}
